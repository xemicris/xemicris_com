import{getProjectRoute}from"./getProjectRoutes.js";const server=getProjectRoute(),urlMostrar=`${server}/pixeos/tec/MostrarIncidencias`,selectEstado=`${server}/pixeos/tec/selectEstado`,urlEditar=`${server}/pixeos/tec/modificarEstadoIncidencia`,contenedor=document.querySelector("#incidencias");let idIncidencia,incidenciaValor="",fechaCorregida="",com="";const modalTec=new bootstrap.Modal(document.getElementById("modalTec")),formulario=document.querySelector("form"),select=document.getElementById("estado"),botonTec=document.getElementById("botonTec");function formato(e){return e.replace(/^(\d{4})-(\d{2})-(\d{2})$/g,"$3/$2/$1")}function incidencia(e,t,n,o){const c=document.createElement("tr"),d=document.createElement("input");d.type="hidden",d.value=e.id;const a=document.createElement("td");a.className=o,a.textContent=e.id;const r=document.createElement("td");r.className=o,r.textContent=t;const i=document.createElement("td");i.className=o,i.textContent=e.comentario;const s=document.createElement("td");s.textContent=n;const l=document.createElement("td");l.textContent=e.usuario.nombre;const m=document.createElement("td");m.className="text-center";const u=document.createElement("div");u.className="d-flex justify-content-center gap-2";const h=document.createElement("a");return h.className="btn-editar btn btn-sm btn-primary mt-2",h.textContent="Editar",c.appendChild(d),c.appendChild(a),c.appendChild(r),c.appendChild(i),c.appendChild(s),c.appendChild(l),c.appendChild(m),m.appendChild(u),u.appendChild(h),c}function noUsuario(){for(;contenedor.hasChildNodes();)contenedor.removeChild(contenedor.firstChild);const e=document.createElement("tr"),t=document.createElement("td");t.setAttribute("colspan",6);const n=document.createElement("h3");return n.textContent="No hay incidencias",e.appendChild(t),t.appendChild(n),e}function mostrarIncidencias(){fetch(urlMostrar,{method:"POST"}).then((e=>e.json())).then((e=>{if(0!=e.length){for(;contenedor.hasChildNodes();)contenedor.removeChild(contenedor.firstChild);e.forEach((e=>{for("0"==e.estado?(incidenciaValor="No resuelta",com=""):"1"==e.estado&&(incidenciaValor="Resuelta",com="tarea-completada"),fechaCorregida=formato(e.fecha);contenedor.hasChildNodes();)contenedor.removeChild(contenedor.firstChild);contenedor.appendChild(incidencia(e,fechaCorregida,incidenciaValor,com))}))}else contenedor.appendChild(noUsuario())}))}mostrarIncidencias();const on=(e,t,n,o)=>{e.addEventListener(t,(e=>{e.target.closest(n)&&o(e)}))};function estados(e){for(;select.hasChildNodes();)select.removeChild(select.firstChild);const t=document.createElement("option");t.setAttribute("value",0),t.textContent="No resuelta";const n=document.createElement("option");return n.setAttribute("value",1),n.textContent="Resuelta","0"===e?t.setAttribute("selected",""):"1"===e&&n.setAttribute("selected",""),select.appendChild(t),select.appendChild(n),select}on(document,"click",".btn-editar",(e=>{const t=e.target.parentNode.parentNode.parentNode;idIncidencia=t.children[0].value;const n=new FormData;n.append("idIncidencia",idIncidencia),fetch(selectEstado,{method:"POST",mode:"cors",cache:"no-cache",body:n}).then((e=>e.json())).then((e=>{estados(e.estado),modalTec.show()}))})),botonTec.addEventListener("click",(()=>{const e=new FormData(formulario);e.append("idIncidencia",idIncidencia),fetch(urlEditar,{method:"POST",mode:"cors",cache:"no-cache",body:e}).then((e=>e.json())).then((e=>{e?(Swal.fire({icon:"success",title:"Estado de la incidencia modificado correctamente",showConfirmButton:!1,timer:1500}),modalTec.hide(),mostrarIncidencias()):(Swal.fire({icon:"error",title:"Ha habido un error",text:e[0]+" y "+e[1]}),modalTarea.hide())}))}));