import{noteRoutes,noteConstants}from"./projectData.js";import{note}from"./note.js";import{noNotes}from"./noNotes.js";import{validarEmail}from"./validar.js";import{useFetch}from"./useFetch.js";import{alerts}from"./alerts.js";import{pdf}from"./pdf.js";const{todasNotas:todasNotas,creaProyecto:creaProyecto,editaProyecto:editaProyecto,enviaIdEditar:enviaIdEditar,eliminaProyecto:eliminaProyecto,urlCrear:urlCrear,urlDescargar:urlDescargar,agregarNotaCompartida:agregarNotaCompartida,eliminarNotaCompartida:eliminarNotaCompartida,buscarUsuariosCompartenNota:buscarUsuariosCompartenNota,enviarNotaACorreo:enviarNotaACorreo}=noteRoutes(),{formulario:formulario,crear:crear,nombre:nombre,tituloNota:tituloNota,body:body,botonCrearEditar:botonCrearEditar,proyectos:proyectos,tituloCrear:tituloCrear,descripcionCrear:descripcionCrear,fechaCrear:fechaCrear,tipoNotificacion:tipoNotificacion,descripcionCaracteresInput:descripcionCaracteresInput,nombreCaracteresInput:nombreCaracteresInput,descripcionCaracteresTextArea:descripcionCaracteresTextArea,radioNotas:radioNotas}=noteConstants();let opcion="";window.onbeforeunload=function(){localStorage.setItem("tipoNota",1)},mostrarProyectos();const modalNotaCrearEditar=new bootstrap.Modal(document.getElementById("modalNotaCrearEditar"),!0),modalTareaCrear=new bootstrap.Modal(document.getElementById("modalTareaCrear"),!0);function mayuscula(e){const t=e.charAt(0),r=e.slice(1);return t.toUpperCase()+r}function ordenar(e,t){return e.sort((function(e,r){let a=mayuscula(e[t]),o=mayuscula(r[t]);return a>o?1:a<o?-1:0})),e}async function mostrarProyectos(e=1){let t=0;try{let r=await useFetch(todasNotas),a=!1,o=!0,c="";if(r.proyectos.length>0){for(;proyectos.hasChildNodes();)proyectos.removeChild(proyectos.firstChild);if(ordenar(r.proyectos,"nombreProyecto").forEach((r=>{if(a=r.compartida>0,o=!r.ko,r.usuarioComparte&&(c=r.usuarioComparte),ordenar(r.tareas,"nombreTarea").forEach((e=>{1==e.estado?e.estado="tarea-completada":0==e.estado&&(e.estado="")})),"0"==r.completado&&1===e)proyectos.appendChild(note(!1,r.urlProyecto,r.colorProyecto,r.nombreProyecto,r.tareas,r.id,a,o,c)),t+=1;else if("1"==r.completado&&2===e)proyectos.appendChild(note(!0,r.urlProyecto,r.colorProyecto,r.nombreProyecto,r.tareas,r.id,a,o,c)),t+=1;else if(3===e){const e="1"==r.completado;proyectos.appendChild(note(e,r.urlProyecto,r.colorProyecto,r.nombreProyecto,r.tareas,r.id,a,o,c)),t+=1}c=""})),0===t){for(;proyectos.hasChildNodes();)proyectos.removeChild(proyectos.firstChild);proyectos.appendChild(noNotes())}}else{for(;proyectos.hasChildNodes();)proyectos.removeChild(proyectos.firstChild);proyectos.appendChild(noNotes())}}catch(e){alerts("error","Ha ocurrido un error, inténtalo de nuevo más tarde",!1,3e3,"","","","Cerrar")}}crear.forEach((e=>{e.addEventListener("click",(()=>{body.classList.remove(".modal-backdrop"),nombre.value="",tituloNota.textContent="Nueva tarea",botonCrearEditar.textContent="Crear",modalNotaCrearEditar.show(),opcion="crear"}))}));const on=(e,t,r,a)=>{e.addEventListener(t,(e=>{for(const t of r)if(e.target.closest(t)){a(e);break}}))},tipoNota=e=>{localStorage.removeItem("tipoNota");const t=e.target.value;"completadas"===t?(mostrarProyectos(2),localStorage.setItem("tipoNota",2)):"noCompletadas"===t?(mostrarProyectos(1),localStorage.setItem("tipoNota",1)):"todas"===t&&(mostrarProyectos(3),localStorage.setItem("tipoNota",3))};async function enviarIdNotaAEditar(e){try{const t={idProyecto:obteneridProyecto(e)};await useFetch(enviaIdEditar,"",t,[],!1)}catch(e){alerts("error","Ha ocurrido un error, inténtalo de nuevo más tarde",!1,3e3,"","","","Cerrar")}}function obteneridProyecto(e){return e.target.id}function gestionarCaracteresTareas(e,t){let r;"input"===t?(r=40-e,descripcionCaracteresInput.textContent=`${r} caracteres restantes`,nombreCaracteresInput.textContent=`${r} caracteres restantes`):"textarea"===t&&(r=1500-e,descripcionCaracteresTextArea.textContent=`${r} caracteres restantes`),r<=0&&"input"===t?(descripcionCaracteresInput.classList.add("caracteresRojo"),nombreCaracteresInput.classList.add("caracteresRojo")):r<=0&&"textarea"===t?descripcionCaracteresTextArea.classList.add("caracteresRojo"):(descripcionCaracteresInput.classList.contains("caracteresRojo")&&descripcionCaracteresInput.classList.remove("caracteresRojo"),nombreCaracteresInput.classList.contains("caracteresRojo")&&nombreCaracteresInput.classList.remove("caracteresRojo"),descripcionCaracteresTextArea.classList.contains("caracteresRojo")&&descripcionCaracteresTextArea.classList.remove("caracteresRojo"))}radioNotas.forEach((e=>{e.addEventListener("change",tipoNota)})),on(document,"click",[".editar"],(e=>{opcion="editar";const t=document.getElementById("nombre"),r=e.target.closest(".primero").firstElementChild?.firstElementChild?.textContent||"";t.value=r,enviarIdNotaAEditar(e),tituloNota.textContent="Editar tarea",botonCrearEditar.textContent="Guardar",modalNotaCrearEditar.show()})),CrearEditarNota.addEventListener("click",(async e=>{if(e.preventDefault(),"crear"==opcion){const e=await useFetch(creaProyecto,formulario);if("valido"==e){modalNotaCrearEditar.hide(),alerts("success","Nota creada correctamente",!1,1500,"","","","Cerrar");mostrarProyectos(parseInt(localStorage.getItem("tipoNota")))}else alerts("","invalido"==e?"Nombre de nota no válida":"Nombre de nota requerida","","","","","","Cerrar")}if("editar"==opcion){if(document.querySelector("#nombre").value){const e=await useFetch(editaProyecto,formulario);if(e.length>0)if("valido"==e){modalNotaCrearEditar.hide(),alerts("success","Nota editada correctamente",!1,1500,"","","","Cerrar");mostrarProyectos(parseInt(localStorage.getItem("tipoNota")))}else alerts("","invalido"==e?"Nombre de nota no válida":"Nombre de nota requerida","","","","","","Cerrar")}else alerts("","Nombre de nota requerida","","","","","","Cerrar")}})),on(document,"click",[".eliminar"],(e=>{try{const t={idProyecto:obteneridProyecto(e)};alerts("warning","¿Seguro que quieres eliminar la nota?","",1500,!0,"#3085d6","#d33","Si!","No").then((e=>{e.isConfirmed&&useFetch(eliminaProyecto,"",t).then((e=>{if(e)if(e){alerts("","¡Nota Eliminada!","","","","","","Cerrar");mostrarProyectos(parseInt(localStorage.getItem("tipoNota")))}else alerts("","¡Nota no eliminada!","","","","","","Cerrar")}))}))}catch(e){alerts("error","Ha ocurrido un error, inténtalo de nuevo más tarde",!1,3e3,"","","","Cerrar")}})),on(document,"click",[".cancelar"],(e=>{formulario.reset();document.querySelector(".btn-close").onclick=function(){formulario.reset()}})),on(document,"click",[".nuevaT"],(e=>{let t=document.getElementById("encabezadoCrear"),r=e.target.parentNode.parentNode.children[0].childNodes[0].classList[4],a=e.target.parentNode.parentNode.childNodes[0].attributes[0].nodeValue.split("/"),o=a[a.length-1];localStorage.setItem("urlProyecto",o);const c=document.querySelector(".tarea-header-modal");body.classList.remove(".modal-backdrop"),tituloCrear.value="",descripcionCrear.value="",fechaCrear.value="",c.classList.remove(r),c.classList.add(r),t.textContent="Nueva tarea",botonTareas.textContent="Crear",modalTareaCrear.show(),opcion="crear",Array.from(tipoNotificacion,(e=>{e.removeAttribute("selected")}))})),on(document,"click",[".cerrar"],(e=>{let t=e.target.parentNode.parentNode.parentNode.parentNode.firstChild.nextElementSibling.classList[2];document.querySelector(".tarea-header-modal").classList.remove(t),localStorage.removeItem("urlProyecto")})),botonTareas.addEventListener("click",(async()=>{const e=document.querySelector("#formularioTarea");if("crear"==opcion){const t={urlProyecto:localStorage.getItem("urlProyecto")?localStorage.getItem("urlProyecto"):""};switch(await useFetch(urlCrear,e,t)){case"Afecha":alerts("error","Ha habido un error","","","","","","Cerrar","","¡Establezca una fecha si quiere recibir la notificación por email!");break;case"MenorFecha":alerts("error","Ha habido un error","","","","","","Cerrar","","¡Para recibir una notificación, la fecha debe ser 24h posterior a hoy, como mínimo!");break;case!0:alerts("success","Tarea creada",!1,1500,"","","","Cerrar");break;default:alerts("error","Ha habido un error","","","","","","Cerrar","","La tarea no se ha creado");break}modalTareaCrear.hide();mostrarProyectos(parseInt(localStorage.getItem("tipoNota")))}})),on(document,"keyup",["#descripcionCrear","#tituloCrear","#nombre"],(e=>{const t=e.target.localName;gestionarCaracteresTareas(e.target.value.length,t)})),on(document,"click",[".editar"],(e=>{gestionarCaracteresTareas(nombre.value.length,"input")})),on(document,"click",[".cerrar"],(e=>{descripcionCaracteresInput.textContent="40 caracteres restantes",nombreCaracteresInput.textContent="40 caracteres restantes",descripcionCaracteresTextArea.textContent="1500 caracteres restantes"})),on(document,"click",[".icono--pdf"],(async e=>{e.preventDefault();const t={idProyecto:e.target.id},r=await useFetch(urlDescargar,"",t,[],!0,!1);r&&pdf(r)})),on(document,"click",[".icono--compartir"],(e=>{e.preventDefault();const t=e.target.id;Swal.fire({title:"Correo del usuario para compartir la nota",input:"text",inputAttributes:{autocapitalize:"off"},cancelButtonColor:"#dc3545",reverseButtons:!0,showCancelButton:!0,confirmButtonText:"Compartir",cancelButtonText:"Cancelar",showLoaderOnConfirm:!0,preConfirm:async e=>{if(validarEmail(e))try{const r=[{idNota:t},{email:e}],a=await useFetch(agregarNotaCompartida,"","",r);if("Nota compartida correctamente"!=a[0])Swal.showValidationMessage(`\n                            Atención: ${a}\n                        `);else{alerts("success","Nota compartida con "+a[1]+" correctamente",!1,3e3,"","","","Cerrar");mostrarProyectos(parseInt(localStorage.getItem("tipoNota")))}}catch(e){Swal.showValidationMessage(`\n                    Request failed: ${e}\n                    `)}else Swal.showValidationMessage("\n                    Atención: Email no válido\n                ")},allowOutsideClick:()=>!Swal.isLoading()})})),on(document,"click",[".icono--descompartir"],(e=>{e.preventDefault();const t=e.target.id;Swal.fire({title:"¿Está seguro que desea dejar de compartir la nota?",cancelButtonColor:"#dc3545",reverseButtons:!0,showCancelButton:!0,confirmButtonText:"Dejar de compartir",cancelButtonText:"Cancelar",showLoaderOnConfirm:!0,preConfirm:async()=>{try{const e={idNota:t},r=await useFetch(eliminarNotaCompartida,"",e);if(0==r[1])Swal.showValidationMessage(`\n                            Atención: ${r[0]}\n                        `);else{alerts("success","Nota dejada de compartir con "+r[1]+" correctamente",!1,3e3,"","","","Cerrar");mostrarProyectos(parseInt(localStorage.getItem("tipoNota")))}}catch(e){Swal.showValidationMessage(`\n                    Request failed: ${e}\n                `)}},allowOutsideClick:()=>!Swal.isLoading()})})),on(document,"click",[".icono--informacion"],(async e=>{try{let t="";e.preventDefault();const r={idNota:e.target.id},a=await useFetch(buscarUsuariosCompartenNota,"",r);a.length<=0?alerts("info","No está compartiendo esta nota","","","","","","Cerrar","","",!1,!1):(a.forEach((e=>{t+=e.nombre+"\n"})),alerts("info","Comparte la nota con los siguientes usuarios:","","","","","","Cerrar","",t,!1,!1))}catch(e){Swal.showValidationMessage(`\n            Request failed: ${e}\n        `)}})),on(document,"click",[".icono--mensaje"],(e=>{e.preventDefault();const t=e.target.id;Swal.fire({title:"Introduce el correo para enviar la nota",input:"text",inputAttributes:{autocapitalize:"off"},cancelButtonColor:"#dc3545",reverseButtons:!0,showCancelButton:!0,confirmButtonText:"Enviar",cancelButtonText:"Cancelar",showLoaderOnConfirm:!0,preConfirm:async e=>{if(validarEmail(e))try{const r=[{idNota:t},{email:e}],a=await useFetch(enviarNotaACorreo,"","",r);if("Correo enviado correctamente"!=a[0])Swal.showValidationMessage("Tu nota debe tener al menos una tarea");else{alerts("success",a[1]+", el correo se ha enviado a "+a[2],!1,3e3,"","","","Cerrar","","",!1,!1);mostrarProyectos(parseInt(localStorage.getItem("tipoNota")))}}catch(e){Swal.showValidationMessage(`\n                        Request failed: ${e}\n                    `)}else Swal.showValidationMessage("\n                    Atención: Email no válido\n                ")},allowOutsideClick:()=>!Swal.isLoading()})}));