import{getProjectRoute}from"./getProjectRoutes.js";const server=getProjectRoute();let mesActual=((new Date).getMonth()+1).toString(),anoActual=(new Date).getFullYear(),anterior=document.getElementById("anterior"),siguiente=document.getElementById("siguiente");const main=document.querySelector(".main");let dias,diaClicado,ventanasModales;anterior.addEventListener("click",reducirMes),siguiente.addEventListener("click",aumentarMes),toastr.options={closeButton:!0,positionClass:"toast-top-center",onclick:null,preventDuplicates:!0,preventOpenDuplicates:!0,showDuration:"300",hideDuration:"1000",timeOut:"0",extendedTimeOut:"0",showEasing:"swing",hideEasing:"linear",showMethod:"show",hideMethod:"hide",tapToDismiss:!0};var wrap,label,months=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];function reducirMes(){"0"===mesActual.substring(0,1)&&(mesActual=mesActual.slice(1,2)),mesActual-=1,mesActual<1&&(mesActual=12,anoActual-=1),mostrarTareasEnCalendario()}function aumentarMes(){"0"===mesActual.substring(0,1)&&(mesActual=mesActual.slice(1,2)),mesActual=Number(mesActual)+1,mesActual.toString(),mesActual>12&&(mesActual=1,anoActual+=1),mostrarTareasEnCalendario()}function init(e){wrap=$(e||"#calendario"),label=wrap.find("#label"),wrap.find("#anterior").bind("click.calendar",(function(){switchMonth(!1)})),wrap.find("#siguiente").bind("click.calendar",(function(){switchMonth(!0)})),label.bind("click",(function(){switchMonth(null,(new Date).getMonth(),(new Date).getFullYear())})),label.click(),mostrarTareasEnCalendario()}function switchMonth(e,a,t){var r,n=label.text().trim().split(" "),o=parseInt(n[1],10);a=a||(e?"Diciembre"===n[0]?0:months.indexOf(n[0])+1:"Enero"===n[0]?11:months.indexOf(n[0])-1),r=createCal(t=t||(e&&0===a?o+1:e||11!==a?o:o-1),a),$("#calendario_grid",wrap).find(".actual").removeClass("actual").addClass("temp").end().prepend(r.calendar()).find(".temp").fadeOut(1,(function(){$(this).remove()})),$("#label").text(r.label),dias=document.querySelectorAll(".dia")}function createCal(e,a){var t,r,n=1,o=!0,s=new Date(e,a,n).getDay(),i=[31,e%4==0&&e%100!=0||e%400==0?29:28,31,30,31,30,31,31,30,31,30,31],c=[];if(createCal.cache[e]){if(createCal.cache[e][a])return createCal.cache[e][a]}else createCal.cache[e]={};for(t=0;o;){for(c[t]=[],r=0;r<7;r++)0===t?r+1===s&&(c[t][r]=n++,s++):n<=i[a]?c[t][r]=n++:(c[t][r]="",o=!1),n>i[a]&&(o=!1);t++}if(c[5]){for(t=0;t<c[5].length;t++)""!==c[5][t]&&(c[4][t]="<span>"+c[4][t]+"</span><span>"+c[5][t]+"</span>");c=c.slice(0,5)}for(t=0;t<c.length;t++)c[t]="<tr><td>"+c[t].join("</td><td>")+"</td></tr>";return c=$("<table>"+c.join("")+"</table>").addClass("actual"),$("td:empty",c).addClass("vacio"),$("td",c).addClass("dia"),a===(new Date).getMonth()&&$("td",c).filter((function(){return $(this).text()===(new Date).getDate().toString()})).addClass("hoy"),createCal.cache[e][a]={calendar:function(){return c.clone()},label:months[a]+" "+e},dias=document.querySelectorAll(".dia"),createCal.cache[e][a]}async function obtenerTareas(){let e=[],a=[],t=[],r=[],n=[],o=await fetch(`${server}/pixeos/panel/mostrarTareasCalendario`,{method:"POST",mode:"cors",cache:"no-cache"}),s=await o.json();if(s)for(let o in s)n.push(s[o].id),e.push(s[o].fecha),a.push(s[o].nombreTarea),t.push(s[o].descripcionTarea),r.push(s[o].estado);return{id:n,fechaTareas:e,nombreTareas:a,descripcionTareas:t,estado:r}}async function mostrarTareasEnCalendario(){let e,a=await obtenerTareas();mesActual=mesActual<10?"0"+mesActual:""+mesActual,a&&a.fechaTareas.forEach((a=>{null!==a&&dias.forEach((t=>{t.textContent<10?e+="0"+t.textContent:e+=t.textContent;let r=a.substring(5,7),n=a.substring(8,a.length),o=a.substring(0,4);anoActual==o&&mesActual==r&&e==n&&(t.classList.add("tarea-calendario"),t.addEventListener("click",tareasModal)),e=""}))}))}createCal.cache={};const tareasModal=async e=>{let a,t,r=[],n=[],o="";if(diaClicado=e.target.textContent,diaClicado<10&&(diaClicado="0"+diaClicado),diaClicado){let e=await obtenerTareas();for(let a=0;a<e.fechaTareas.length;a++)r+=e.estado[a]+e.nombreTareas[a]+e.fechaTareas[a]+"|";n=r.split("|").reverse(),n.forEach((e=>{a=e.substring(e.length-2),t=e.substring(e.length-5).substring(0,2),o=e.substring(1,e.length-10),diaClicado==a&&mesActual==t&&(0==e.substring(0,1)?toastr.info(o,"TAREA"):toastr.info(o,"TAREA",{messageClass:"tarea_completada"}))})),ventanasModales=document.querySelectorAll(".toast"),insertarId(),crearBotonCerrarModales(),ventanasModales.forEach((e=>{e.addEventListener("click",enviarId),e.children[0].addEventListener("click",(function(){ventanasModales=document.querySelectorAll(".toast"),ventanasModales.length-1<1&&cerrarModales()}))}))}},insertarId=async()=>{let e=await obtenerTareas(),a="",t="";if(e.fechaTareas.forEach((e=>{null!=e&&(t=e.substring(e.length-2),diaClicado==t&&(a=e))})),""!==a){const e=new FormData;e.append("fecha",a);let t=await fetch(`${server}/pixeos/panel/obtenerIdsSegunFecha`,{method:"POST",mode:"cors",cache:"no-cache",body:e}),r=await t.json();for(let e=0;e<r.length;e++)ventanasModales[e].id=r[e].id}},enviarId=async e=>{let a;if(a="toast-container"==e.target.parentNode.getAttribute("id")?e.target.getAttribute("id"):a=e.target.parentNode.getAttribute("id"),""!=a){const e=new FormData;e.append("idTarea",a);let t=await fetch(`${server}/pixeos/panel/llevarAProyectoDesdeCalendario`,{method:"POST",mode:"cors",cache:"no-cache",body:e}),r=await t.json();location.href=`${server}/pixeos/panel/project/${r.urlProyecto}`}},crearBotonCerrarModales=()=>{if(!document.querySelector(".botonCerrarModales")){const e=document.createElement("button");e.setAttribute("class","botonCerrarModales"),e.textContent="Cerrar",main.insertBefore(e,main.firstChild);document.querySelector(".botonCerrarModales").addEventListener("click",cerrarModales)}},cerrarModales=()=>{const e=document.querySelector(".botonCerrarModales");window.toastr.clear(),setTimeout((()=>{main.removeChild(e)}),300)};init(),createCal();