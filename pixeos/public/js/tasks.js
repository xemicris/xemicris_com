import{taskRoutes,taskConstants}from"./projectData.js";import{useFetch}from"./useFetch.js";import{task}from"./task.js";import{ordenarTareasPorFecha,ordenarTareasPorNombre}from"./order.js";import{convertirFechaEspanol,convertirFechaIngles}from"./conversions.js";const{urlMostrar:urlMostrar,urlCrear:urlCrear,urlEditar:urlEditar,urlCompletar:urlCompletar,urlEliminar:urlEliminar,urlEliminarTodo:urlEliminarTodo,urlPorcentaje:urlPorcentaje}=taskRoutes(),{contenedor:contenedor,botonTareas:botonTareas,body:body,btnEliminarTodo:btnEliminarTodo,descripcionTarea:descripcionTarea,iconoNotificacionSi:iconoNotificacionSi,iconoNotificacionNo:iconoNotificacionNo,descripcionCaracteresInput:descripcionCaracteresInput,descripcionCaracteresTextArea:descripcionCaracteresTextArea,iconoNombre:iconoNombre,iconoCalendario:iconoCalendario,maximoTextArea:maximoTextArea,maximoInput:maximoInput,formulario:formulario,modalTareaCrearEditar:modalTareaCrearEditar,modalTareaMostrar:modalTareaMostrar,tituloCrearEditar:tituloCrearEditar,descripcionCrearEditar:descripcionCrearEditar,fechaCrearEditar:fechaCrearEditar,tituloMostrar:tituloMostrar,fechaMostrar:fechaMostrar,descripcionMostrar:descripcionMostrar,tipoNotificacion:tipoNotificacion}=taskConstants();let headerCrearEditar=document.getElementById("encabezadoCrearEditar"),headerMostrar=document.getElementById("encabezadoMostrar"),opcion="";mostrarTareas();const on=(a,e,r,o)=>{a.addEventListener(e,(a=>{for(const e of r)if(a.target.closest(e)){o(a);break}}))};function tareasSeparadas(a,e="nombre"){let r=[],o=[],t=[],i=[],c=[],n=[],s=[];return a.forEach((a=>{1==a.estado?(a.completada="tarea-completada",a.checked="checked",c.push(a)):0==a.estado&&(a.completada="",a.checked="",n.push(a))})),"calendario"==e?(c.length>0&&c.forEach((a=>{null!=a.fecha?r.push(a):o.push(a)})),n.length>0&&n.forEach((a=>{null!=a.fecha?t.push(a):i.push(a)})),o=ordenarTareasPorNombre(o),i=ordenarTareasPorNombre(i),c=r.concat(o),n=t.concat(i),c=ordenarTareasPorFecha(c),n=ordenarTareasPorFecha(n),s=n.concat(c),void mostrarTareas(s)):"nombreclic"==e?(c=ordenarTareasPorNombre(c),n=ordenarTareasPorNombre(n),s=n.concat(c),void mostrarTareas(s)):("nombre"==e&&(c=ordenarTareasPorNombre(c),n=ordenarTareasPorNombre(n)),s=n.concat(c),s)}async function mostrarTareas(a=""){if(""==a){let a;await useFetch(urlMostrar).then((e=>{if(0!=e.length){for(;contenedor.hasChildNodes();)contenedor.removeChild(contenedor.firstChild);a=tareasSeparadas(e),a.forEach(((a,e,r)=>{let o="";o=e===r.length-1?"insertar":"",task(!0,o,a,contenedor)})),btnEliminarTodo.classList.remove("btnEliminarTodoOculto")}else{for(;contenedor.hasChildNodes();)contenedor.removeChild(contenedor.firstChild);task(!1,contenedor),btnEliminarTodo.classList.add("btnEliminarTodoOculto")}})).then(porcentaje()).then(navegacionFija())}else if(0!=a.length){for(;contenedor.hasChildNodes();)contenedor.removeChild(contenedor.firstChild);a.forEach(((a,e,r)=>{let o="";o=e===r.length-1?"insertar":"",task(!0,o,a,contenedor)})),btnEliminarTodo.classList.remove("btnEliminarTodoOculto")}else{for(;contenedor.hasChildNodes();)contenedor.removeChild(contenedor.firstChild);task(!1,contenedor),btnEliminarTodo.classList.add("btnEliminarTodoOculto")}}on(document,"click",[".icono--orden"],(async a=>{const e=await useFetch(urlMostrar);if(0!=e.length){let r=a.target.classList;r.contains("icono--orden__calendario")?(tareasSeparadas(e,"calendario"),iconoCalendario.classList.add("iconosRojos"),iconoNombre.classList.contains("iconosRojos")&&iconoNombre.classList.remove("iconosRojos"),iconoCalendario.classList.contains("iconoCalendario--claro")&&iconoCalendario.classList.remove("iconoCalendario--claro")):r.contains("icono--orden__nombre")&&(tareasSeparadas(e,"nombreclic"),iconoNombre.classList.add("iconosRojos"),iconoCalendario.classList.contains("iconosRojos")&&iconoCalendario.classList.remove("iconosRojos"),iconoCalendario.classList.contains("iconoCalendario--claro")||iconoCalendario.classList.add("iconoCalendario--claro"))}})),btnCrear.addEventListener("click",(()=>{body.classList.remove(".modal-backdrop"),tituloCrearEditar.value="",descripcionCrearEditar.value="",fechaCrearEditar.value="",headerCrearEditar.textContent="Nueva tarea",botonTareas.textContent="Crear",modalTareaCrearEditar.show(),opcion="crear",Array.from(tipoNotificacion,(a=>{a.removeAttribute("selected")}))}));let idEditar=0;function barraProgreso(a,e,r,o){let t=document.getElementById("barra-progreso");for(;t.hasChildNodes();)t.removeChild(t.firstChild);const i=document.createElement("div");return i.style=`width: ${a}%`,i.className=`progress-bar progress-bar-striped bg-${e} fs-4 fw-bold pb-1 text-${r}`,i.setAttribute("role","progressbar"),i.setAttribute("aria-label","Default striped example"),i.setAttribute("aria-valuenow","100"),i.setAttribute("aria-valuemin","0"),i.setAttribute("aria-valuemax","100"),i.textContent=o,i}async function porcentaje(){try{const a=document.getElementById("barra-progreso"),e=await useFetch(urlPorcentaje);let r=e+"%",o="",t="";e<25?(o="danger",t="white"):e<=50?(o="warning",t="dark"):e<=75?(o="info",t="dark"):100==e&&(o="success",r="¡Completado!",t="white"),a.innerHTML="",a.appendChild(barraProgreso(e,o,t,r))}catch(a){}}function navegacionFija(){setTimeout((()=>{if(window.innerWidth<568){const a=document.querySelector(".panelTareas"),e=document.querySelector(".insertar"),r=document.querySelector("body");window.addEventListener("scroll",(function(){e.getBoundingClientRect().top>700?(a.classList.add("fijo"),r.classList.add("body-scroll")):(a.classList.remove("fijo"),r.classList.remove("body-scroll"))}))}}),500)}function gestionarCaracteresTareas(a,e=""){let r=0,o=0;"object"==typeof a?(r=maximoInput-a.tituloCrearEditar,o=maximoTextArea-a.descripcionCrearEditar,descripcionCaracteresInput.textContent=`${r} caracteres restantes`,descripcionCaracteresTextArea.textContent=`${o} caracteres restantes`,r<=0?descripcionCaracteresInput.classList.add("caracteresRojo"):descripcionCaracteresInput.classList.contains("caracteresRojo")&&descripcionCaracteresInput.classList.remove("caracteresRojo"),o<=0?descripcionCaracteresTextArea.classList.add("caracteresRojo"):descripcionCaracteresTextArea.classList.contains("caracteresRojo")&&descripcionCaracteresTextArea.classList.remove("caracteresRojo")):("input"===e?(r=maximoInput-a,descripcionCaracteresInput.textContent=`${r} caracteres restantes`):"textarea"===e&&(o=maximoTextArea-a,descripcionCaracteresTextArea.textContent=`${o} caracteres restantes`),r<=0&&"input"===e?descripcionCaracteresInput.classList.add("caracteresRojo"):o<=0&&"textarea"===e?descripcionCaracteresTextArea.classList.add("caracteresRojo"):(descripcionCaracteresInput.classList.contains("caracteresRojo")&&descripcionCaracteresInput.classList.remove("caracteresRojo"),descripcionCaracteresTextArea.classList.contains("caracteresRojo")&&descripcionCaracteresTextArea.classList.remove("caracteresRojo")))}on(document,"click",[".btn-editar"],(async a=>{const e=a.target.closest("tr");idEditar=e.firstChild.value,Array.from(tipoNotificacion,(a=>{a.removeAttribute("selected")})),opcion="editar",headerCrearEditar.textContent="Editar tarea",fechaCrearEditar.value="";const r=await useFetch(urlMostrar);0!=r.length&&r.forEach((a=>{idEditar===a.id&&(tituloCrearEditar.value=a.nombreTarea,descripcionCrearEditar.value=a.descripcionTarea,null!=a.fecha&&(fechaCrearEditar.value=convertirFechaIngles(a.fecha)),""!=a.notificacion&&Array.from(tipoNotificacion,(e=>{a.notificacion==e.value&&e.setAttribute("selected",!0)})))})),botonTareas.textContent="Guardar",modalTareaCrearEditar.show()})),on(document,"click",[".btn-mostrar"],(async a=>{descripcionTarea.classList.add("mostrarTarea"),tituloMostrar.textContent="",descripcionMostrar.textContent="";const e=a.target.closest("tr");idEditar=e.firstElementChild.value,headerMostrar.textContent="Tarea";const r=await useFetch(urlMostrar);0!=r.length&&r.forEach((a=>{if(idEditar===a.id)if(tituloMostrar.textContent=a.nombreTarea,descripcionMostrar.textContent=a.descripcionTarea,"unica"==a.notificacion||"diaria"==a.notificacion||"semanal"==a.notificacion||"mensual"==a.notificacion?(iconoNotificacionSi&&iconoNotificacionSi.classList.remove("iconoNotificacion__si"),iconoNotificacionNo&&iconoNotificacionNo.classList.add("iconoNotificacion__no")):(iconoNotificacionSi&&iconoNotificacionSi.classList.add("iconoNotificacion__si"),iconoNotificacionNo&&iconoNotificacionNo.classList.remove("iconoNotificacion__no")),null==a.fecha){document.querySelector("#fechaLabel").classList.add("ocultarLabel"),a.fecha=null}else fechaLabel.classList.remove("ocultarLabel"),null!=a.fecha&&(fechaMostrar.textContent=convertirFechaEspanol(a.fecha))})),modalTareaMostrar.show()})),botonTareas.addEventListener("click",(async()=>{if("crear"==opcion){const a=await useFetch(urlCrear,formulario);"Afecha"==a?(Swal.fire({icon:"error",title:"Ha habido un error",text:"¡Establezca una fecha si quiere recibir la notificación por email!"}),modalTareaCrearEditar.hide(),mostrarTareas()):"MenorFecha"==a?(Swal.fire({icon:"error",title:"Ha habido un error",text:"¡Para recibir una notificación, la fecha debe ser 24h posterior a hoy, como mínimo!"}),modalTareaCrearEditar.hide(),mostrarTareas()):1==a?(Swal.fire({icon:"success",title:"Tarea creada",showConfirmButton:!1,timer:1500}),modalTareaCrearEditar.hide(),btnEliminarTodo.classList.remove("btnEliminarTodoOculto"),mostrarTareas()):(Swal.fire({icon:"error",title:"Ha habido un error",text:"La tarea no se ha creado!"}),modalTareaCrearEditar.hide())}if("editar"==opcion){const a=tituloCrearEditar.value;if(fechaCrearEditar.textContent="",a){const a={idTarea:idEditar},e=await useFetch(urlEditar,formulario,a);e?("Afecha"==e?(Swal.fire({icon:"error",title:"Ha habido un error",text:"¡Establezca una fecha si quiere recibir la notificación por email!"}),modalTareaCrearEditar.hide(),mostrarTareas()):"MenorFecha"==e?(Swal.fire({icon:"error",title:"Ha habido un error",text:"¡Para recibir una notificación, la fecha debe ser 24h posterior a hoy, como mínimo!"}),modalTareaCrearEditar.hide(),mostrarTareas()):Swal.fire({icon:"success",title:"Tarea editada",showConfirmButton:!1,timer:1500}),modalTareaCrearEditar.hide(),mostrarTareas()):(Swal.fire({icon:"error",title:"Ha habido un error",text:"¡La tarea no se ha editado!"}),modalTareaCrearEditar.hide())}else Swal.fire("Nombre de tarea requerida")}})),on(document,"click",[".btn-eliminar"],(async a=>{const e=a.target.closest("tr").firstElementChild.value;Swal.fire({title:"¿Seguro que quieres eliminar la tarea",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Si!",cancelButtonText:"No"}).then((async a=>{if(a.isConfirmed){const a={idTarea:e};await useFetch(urlEliminar,formulario,a)?(Swal.fire("Eliminada!"),mostrarTareas()):Swal.fire("No Eliminada!")}}))})),on(document,"click",["#btnEliminarTodo"],(a=>{Swal.fire({title:"¿Seguro que quieres eliminar todas las tareas?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Si!",cancelButtonText:"No"}).then((async a=>{if(a.isConfirmed){await useFetch(urlEliminarTodo)?(Swal.fire("Eliminadas!"),btnEliminarTodo.classList.add("btnEliminarTodoOculto"),mostrarTareas()):Swal.fire("No Eliminadas!")}}))})),on(document,"change",[".completado"],(async a=>{let e,r=0;const o=a.target.closest("tr");e=a.target.checked?1:0,r=o.children[0].value;const t=[{estado:e},{idTarea:r}];await useFetch(urlCompletar,"","",t)&&(iconoCalendario.classList.contains("iconosRojos")?fetch(urlMostrar,{method:"POST"}).then((a=>a.json())).then((a=>{tareasSeparadas(a,"calendario")})):mostrarTareas())})),on(document,"keyup",["#descripcionCrearEditar","#tituloCrearEditar"],(a=>{const e=a.target.localName;gestionarCaracteresTareas(a.target.value.length,e)})),on(document,"click",[".btn-editar"],(a=>{setTimeout((()=>{gestionarCaracteresTareas({tituloCrearEditar:tituloCrearEditar.value.length,descripcionCrearEditar:descripcionCrearEditar.value.length},"")}),470)})),on(document,"click",["#btnCrear"],(a=>{descripcionCaracteresInput.textContent="40 caracteres restantes",descripcionCaracteresTextArea.textContent="1500 caracteres restantes",descripcionCaracteresInput.classList.contains("caracteresRojo")&&descripcionCaracteresInput.classList.remove("caracteresRojo"),descripcionCaracteresTextArea.classList.contains("caracteresRojo")&&descripcionCaracteresTextArea.classList.remove("caracteresRojo")}));